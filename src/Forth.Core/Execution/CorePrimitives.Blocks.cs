using Forth.Core.Interpreter; using System.Threading.Tasks; using System.IO; namespace Forth.Core.Execution; internal static partial class CorePrimitives { [Primitive("BLOCK", HelpString="BLOCK ( n -- c-addr u ) load block n")] private static Task Prim_BLOCK(ForthInterpreter i){ i.EnsureStack(1,"BLOCK"); var n=(int)ToLong(i.PopInternal()); i.EnsureBlockExistsOnDisk(n); var addr=i.GetOrAllocateBlockAddr(n); i.LoadBlockFromBacking(n,addr); i.SetCurrentBlockNumber(n); i.Push((long)addr); i.Push((long)ForthInterpreter.BlockSize); return Task.CompletedTask;} [Primitive("SAVE", HelpString="SAVE ( c-addr u n -- ) save bytes to block n")] private static Task Prim_SAVE(ForthInterpreter i){ i.EnsureStack(3,"SAVE"); var n=(int)ToLong(i.PopInternal()); var u=(int)ToLong(i.PopInternal()); var src=i.PopInternal(); if(u<0) throw new ForthException(ForthErrorCode.CompileError,"Negative length"); if(u>ForthInterpreter.BlockSize) u=ForthInterpreter.BlockSize; if(src is string s){ var content=s.Length>u? s.Substring(0,u): s.PadRight(u,' '); i.SetBlockBuffer(n,content); return Task.CompletedTask;} if(src is long addr){ i.SaveBlockToBacking(n,addr,u); return Task.CompletedTask;} throw new ForthException(ForthErrorCode.TypeError,"SAVE expects address or string"); } [Primitive("OPEN-BLOCK-FILE", HelpString="OPEN-BLOCK-FILE <path> open/create block file backing")] private static Task Prim_OPENBLOCKFILE(ForthInterpreter i){ string path = (i.Stack.Count>0 && i.Stack[^1] is string s)? (string)i.PopInternal(): i.ReadNextTokenOrThrow("Expected path after OPEN-BLOCK-FILE"); i.OpenBlockFile(path); return Task.CompletedTask;} [Primitive("OPEN-BLOCK-DIR", HelpString="OPEN-BLOCK-DIR <path> open/create per-block dir backing")] private static Task Prim_OPENBLOCKDIR(ForthInterpreter i){ string path = (i.Stack.Count>0 && i.Stack[^1] is string s)? (string)i.PopInternal(): i.ReadNextTokenOrThrow("Expected path after OPEN-BLOCK-DIR"); i.OpenBlockFile(path, perBlock:true); return Task.CompletedTask;} [Primitive("FLUSH-BLOCK-FILE", HelpString="FLUSH-BLOCK-FILE ( -- ) flush block backing store")] private static Task Prim_FLUSHBLOCKFILE(ForthInterpreter i){ i.FlushBlockFile(); return Task.CompletedTask;} [Primitive("CLOSE-BLOCK-FILE", HelpString="CLOSE-BLOCK-FILE ( -- ) close block backing store")] private static Task Prim_CLOSEBLOCKFILE(ForthInterpreter i){ i.CloseBlockFile(); return Task.CompletedTask;} }